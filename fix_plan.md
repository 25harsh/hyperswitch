# MCP Server API Fix Plan

## Objective
Fix the remaining failing MCP tools by correcting their interaction with the backend API, leveraging the provided test scripts and documentation.

## Overall Status
- **Completed Fixes:** Get User Info, Sign Out, Create Business Profile, Update Business Profile
- **Pending Fixes:** None

## Strategy
1.  Address one failing API tool at a time.
2.  Consult the documentation and test scripts in `jwt_api_docs/` (especially `run_business_profiles_test.sh` and `group*/business_profiles/`) to determine the correct API endpoint, HTTP method, and request payload structure for the target operation.
3.  Compare the correct usage (from tests/docs) with the current implementation in the relevant Python file (`business_profiles.py` or `server.py`).
4.  Modify the Python code to match the correct API interaction pattern.
5.  Test the fix by executing the corresponding MCP tool call.
6.  Update the status of the issue in this plan.

## Detailed Issues & Plan

### 1. Create Business Profile
- **Tool:** `mcp_hyperswitch_user_based_flow_Create_Business_Profile`
- **Implementation:** `business_profiles.py::create_business_profile`
- **Current Status:** FIXED (Successfully created profile `pro_j4RykSEor4CCVVhzdfAd`)
- **Fix Details:** Added missing fields (`enable_payment_response_hash`, `redirect_to_merchant_with_http_post`, `use_billing_as_payment_method_billing`, `session_expiry`) based on test script analysis. Also removed the top-level `description` and the sending of arbitrary `metadata` as these seemed to cause the 400 error.
- **Action Plan:**
    1.  [X] Analyze `jwt_api_docs/run_business_profiles_test.sh` (and potentially files in `group*/business_profiles/`) to find a working example (e.g., `curl` command) for *creating* a business profile.
    2.  [X] Identify the correct payload structure from the working example. (Found missing fields: `enable_payment_response_hash`, `redirect_to_merchant_with_http_post`, `use_billing_as_payment_method_billing`, `session_expiry`).
    3.  [X] Compare the correct payload with the one currently generated by `business_profiles.py::create_business_profile`.
    4.  [X] Modify `business_profiles.py::create_business_profile` to include the missing fields and remove problematic ones (top-level description, arbitrary metadata).
    5.  [X] Test the fix using the `mcp_hyperswitch_user_based_flow_Create_Business_Profile` tool. (Success!)
    6.  [X] Update status to FIXED or note further issues.
- **Relevant Files:** `python-client-sdk/mcp-server/hyperswitch_mcp/business_profiles.py`, `jwt_api_docs/run_business_profiles_test.sh`, `jwt_api_docs/group*/business_profiles/*`

### 2. Update Business Profile
- **Tool:** `mcp_hyperswitch_user_based_flow_Update_Business_Profile`
- **Implementation:** `server.py::update_business_profile_tool` (Direct implementation)
- **Current Status:** FIXED (Successfully updated profile `pro_j4RykSEor4CCVVhzdfAd`)
- **Fix Details:** Determined correct method is POST. Payload should include only provided fields plus potentially required defaults (like `enable_payment_response_hash`). Initial 401 errors likely due to attempting to update a profile the token/key couldn't modify (`pro_UzOxBPeSwDfyHsf04mai`). Succeeded when targeting a profile created via MCP (`pro_j4RykSEor4CCVVhzdfAd`) using `hyperswitch` API key.
- **Action Plan:**
    1.  [X] Analyze `jwt_api_docs/run_business_profiles_test.sh` to find a working example for *updating*. Note HTTP method (POST).
    2.  [X] Identify payload structure (sends full object in test, but problematic). Determine required fields.
    3.  [X] Compare payload/method with `server.py::update_business_profile_tool`.
    4.  [X] Modify `server.py::update_business_profile_tool` to send only provided fields + required defaults via POST.
    5.  [X] Test the fix using the `mcp_hyperswitch_user_based_flow_Update_Business_Profile` tool. (Success after targeting correct profile & using 'hyperswitch' key!)
    6.  [X] Update status to FIXED or note further issues.
- **Relevant Files:** `python-client-sdk/mcp-server/hyperswitch_mcp/server.py`, `jwt_api_docs/run_business_profiles_test.sh`, `jwt_api_docs/group*/business_profiles/*`

---
*Plan updated: 2024-08-20* 